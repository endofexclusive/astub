# Introduction

This directory contains files necessary for building *astub* for *Commodore
Amiga A500*.


# Requirements

- A *m68k* toolchain. Parent directory `README.md` file describes how it can be
  built.


For information on how to build the toolchain, see README.md in the parent
directory.


# Building *astub*

To build the *astub* for the *Commodore Amiga A500*, run `make` in this
directory:

    $ make
    vasmm68k_mot -quiet -phxass -m68000 -Felf  -o exception_68000.o ../../m68k/exception_68000.s
    vasmm68k_mot -quiet -phxass -m68000 -Felf  -o standalone.o ../../amiga/standalone.s
    m68k-elf-gcc -MT hex.o -MMD -MP -MF .d/hex.Td -march=68000 -fomit-frame-pointer -mpcrel -mshort -Os -Wall -Wextra -pedantic -ansi -I../../include -I../../m68k/include -I../../amiga/include -c -o hex.o ../../hex.c
    mv -f .d/hex.Td .d/hex.d
    m68k-elf-gcc -MT pkt.o -MMD -MP -MF .d/pkt.Td -march=68000 -fomit-frame-pointer -mpcrel -mshort -Os -Wall -Wextra -pedantic -ansi -I../../include -I../../m68k/include -I../../amiga/include -c -o pkt.o ../../pkt.c
    mv -f .d/pkt.Td .d/pkt.d
    m68k-elf-gcc -MT cmd.o -MMD -MP -MF .d/cmd.Td -march=68000 -fomit-frame-pointer -mpcrel -mshort -Os -Wall -Wextra -pedantic -ansi -I../../include -I../../m68k/include -I../../amiga/include -c -o cmd.o ../../cmd.c
    mv -f .d/cmd.Td .d/cmd.d
    m68k-elf-gcc -MT stub_arch.o -MMD -MP -MF .d/stub_arch.Td -march=68000 -fomit-frame-pointer -mpcrel -mshort -Os -Wall -Wextra -pedantic -ansi -I../../include -I../../m68k/include -I../../amiga/include -c -o stub_arch.o ../../m68k/stub_arch.c
    mv -f .d/stub_arch.Td .d/stub_arch.d
    m68k-elf-gcc -MT a500_init.o -MMD -MP -MF .d/a500_init.Td -march=68000 -fomit-frame-pointer -mpcrel -mshort -Os -Wall -Wextra -pedantic -ansi -I../../include -I../../m68k/include -I../../amiga/include -c -o a500_init.o ../../amiga/a500_init.c
    mv -f .d/a500_init.Td .d/a500_init.d
    m68k-elf-gcc -MT uart.o -MMD -MP -MF .d/uart.Td -march=68000 -fomit-frame-pointer -mpcrel -mshort -Os -Wall -Wextra -pedantic -ansi -I../../include -I../../m68k/include -I../../amiga/include -c -o uart.o ../../amiga/uart.c
    mv -f .d/uart.Td .d/uart.d
    m68k-elf-gcc -nostdlib exception_68000.o standalone.o hex.o pkt.o cmd.o stub_arch.o a500_init.o uart.o -T a500.ld -o main -Wl,-Map=main.map
    m68k-elf-objcopy -O binary main main.bin
    vasmm68k_mot -quiet -phxass -m68000 -Fhunkexe bload.s -o astub
    cp astub fs/astub
    m68k-elf-objdump -d main > main.asm


# Output files

The following output files, among others, are created:

## `main`

This is the linked *astub* program in ELF format.  The program is constructed
to be fully relocatable by using only PC relative addressing. For C code the
compiler does the trick with the `-mpcrel` parameter.

Also the program is compiled with the `-mshort` parameter which makes the C
`int` type 16-bit. There are no dependencies in the C code on `int` size. The
only known place where a 32-bit C `int` type may not work properly is in
`m68k/exception_68000.s` where `stub_main()` is called and the parameter is
pushed on the stack. Calls to the C library (*Newlib*) may also not work
properly because of the 16-bit `int`.

Note that this is the application in *ELF format* so it can not be loaded by
*AmigaOS*.

`main` clears its `.bss` section, but does not initialize the stack.

It then enters the *astub* main loop waiting for *gdb Remote Serial Protocol*
commands on the *Amiga* built-in serial port.

- `main.asm` is a disassembly of `main`.
- `main.map` is a memory map file for `main` generated by the linker.
- `main.bin` is a binary dump of `main`, including `.text`, `.data` and `.bss`
  (!) sections.


## `astub`

`astub` is an *AmigaOS* executable which loads and starts the `main` program
described above. It should be transfered to an *Amiga* floppy disk or hard
drive on the target and started from the *cli* prompt or via
`s:startup-sequence`.

`bload.s` is the source code of the loader. The following is performed by
`astub` loader, before the `main` program is started:

- Disable interrupts with `INTENA`.
- Stop DMA with `DMACON`.
- Copy `main.bin` to end of 512 KiB chip RAM
- Enter *Supervisor mode*.
- Set *Supervisor Stack Pointer* to start of `main.bin` destination location.
- Jump to entry point (equal to *Supervisor Stack Pointer*).


# Debugging

See `example/` in the parent directory for an example on how *astub* can be
used to connect with a target, either hardware or emulator.

